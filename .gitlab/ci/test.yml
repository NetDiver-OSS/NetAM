ruby:test:
  stage: test
  services:
    - postgres:12.2-alpine
  variables:
    POSTGRES_DB: netam_test
    POSTGRES_USER: admin
    POSTGRES_PASSWORD: password
    POSTGRES_HOST_AUTH_METHOD: trust
  script:
    - apk add --no-cache build-base bash linux-headers tzdata postgresql-dev yarn npm libc6-compat
    - bundle install
    - rails db:migrate RAILS_ENV=test
    - rspec --format RspecJunitFormatter --out rspec.xml
  artifacts:
    reports:
      junit: rspec.xml
    paths:
      - coverage/

rubocop:test:
  stage: test
  script:
    - apk add --no-cache build-base bash linux-headers tzdata postgresql-dev yarn npm libc6-compat
    - bundle install
    - rubocop --format=json --out=rubocop-result.json --fail-level=f
  artifacts:
    paths:
      - rubocop-result.json

owasp:test:
  stage: test
  image: owasp/dependency-check
  script:
    - mkdir owasp
    - /usr/share/dependency-check/bin/dependency-check.sh --scan . --out owasp --format ALL
  artifacts:
    paths:
      - owasp/
