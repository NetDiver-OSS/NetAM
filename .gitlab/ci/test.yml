ruby:test:
  stage: test
  services:
    - postgres:12.2-alpine
    - redis:alpine
  variables:
    POSTGRES_DB: netam_test
    POSTGRES_USER: admin
    POSTGRES_PASSWORD: password
    POSTGRES_HOST_AUTH_METHOD: trust
    SIDEKIQ_PARALLEL: 10
  script:
    - apk add --no-cache build-base bash linux-headers tzdata postgresql-dev yarn npm libc6-compat postgresql-client
    - bundle install
    - rails db:migrate RAILS_ENV=test
    - rails db:seed RAILS_ENV=test
    - rails assets:precompile RAILS_ENV=test
    - rspec --format RspecJunitFormatter --out rspec.xml
  needs: []
  artifacts:
    reports:
      junit: rspec.xml
    paths:
      - coverage/

rubocop:test:
  stage: test
  script:
    - apk add --no-cache build-base bash linux-headers tzdata postgresql-dev yarn npm libc6-compat
    - bundle install
    - rubocop --format=json --out=rubocop-result.json
  needs: []
  artifacts:
    paths:
      - rubocop-result.json
